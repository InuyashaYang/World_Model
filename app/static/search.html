<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœç´¢è°ƒæŸ¥</title>
  <link rel="stylesheet" href="theme.css">
</head>
<body class="wm-page">
  <div class="wm-shell">
    <aside class="wm-side">
      <div class="wm-side-top">
        <div class="wm-brand">
          <div class="wm-brand-title">Deep Research Workbench</div>
          <div class="wm-brand-sub">Topic â†’ OpenAlex â†’ DeepResearch â†’ Profile</div>
        </div>
        <button id="themeBtn" class="btn">åˆ‡æ¢ä¸»é¢˜</button>
      </div>

      <div class="wm-nav">
        <button id="modeTopic" class="wm-nav-item is-active" type="button">ä¸»é¢˜æµæ°´çº¿</button>
        <button id="modePerson" class="wm-nav-item" type="button">äººç‰©æ·±æœ</button>
      </div>

      <div class="wm-side-section">
        <div class="wm-side-h">Sessions</div>
        <div id="sessionList" class="wm-topic-list">
          <div class="muted" style="padding:10px;">æš‚æ— </div>
        </div>
        <div class="wm-side-h" style="margin-top:12px;">ä¸»é¢˜ç»“æœå†å²</div>
        <div id="topicList" class="wm-topic-list">
          <div class="muted" style="padding:10px;">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </aside>

    <main class="wm-main">
      <div class="wm-main-head">
        <div class="wm-main-title">å·¥ä½œåŒº</div>
        <div class="wm-main-meta" id="wmModeHint">ä¸»é¢˜æµæ°´çº¿ï¼šè¾“å…¥ä¸€æ®µè°ƒç ”éœ€æ±‚</div>
      </div>

      <div id="workspace" class="wm-chat"></div>

      <div class="wm-composer" style="position:relative;">
        <div id="runningOverlay" class="wm-input-overlay" style="display:none;">
          <div class="muted"><span class="mono">Job is running...</span></div>
          <button id="btnFastProfile" class="btn" style="border-color:var(--accent); color:var(--accent); display:none;">
            âš¡ ç”¨å½“å‰ DeepResearch ç›´æ¥ç”Ÿæˆ Profile
          </button>
          <button id="btnCancel" class="btn" style="color:var(--danger); border-color:var(--danger);">
            åœæ­¢
          </button>
        </div>

        <div class="wm-composer-row">
          <input id="apiKey" class="input" placeholder="API Keyï¼ˆä»…ä¿å­˜åœ¨æµè§ˆå™¨ä¼šè¯ï¼‰" />
          <label class="wm-checkbox"><input id="deep" type="checkbox" /> é¢å¤–ç»¼è¿°</label>
        </div>
        <div class="wm-composer-row">
          <textarea id="q" class="input" rows="4" placeholder="è¾“å…¥è°ƒç ”éœ€æ±‚ï¼ˆçº¯æ–‡å­—ï¼‰ï¼š\nå»ºè®®åŒ…å«ï¼šä¸»é¢˜/å®šä¹‰ã€æ—¶é—´èŒƒå›´ã€æ’é™¤é¡¹ã€å­æ–¹å‘ã€‚"></textarea>
          <button id="send" class="btn">å‘é€</button>
        </div>
        <div class="muted" style="padding:6px 2px 0;">æç¤ºï¼šå®Œæˆåå¯ä¸€é”®è·³è½¬åˆ° index.html æŸ¥çœ‹å®Œæ•´ profile å¤§è¡¨ï¼ˆå¤ç”¨ç°æˆæ¦œå•é¡µï¼‰ã€‚</div>
      </div>
    </main>
  </div>

  <!-- Need-input Modal -->
  <div id="wmModal" class="wm-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="wm-modal">
      <h3 id="wmModalTitle">éœ€è¦è¡¥å……ä¿¡æ¯</h3>
      <div class="wm-modal-body">
        <div id="wmModalDesc" class="muted" style="margin:0 0 10px; white-space:pre-wrap;"></div>
        <textarea id="wmModalInput" class="input" rows="6" placeholder="è¯·è¡¥å……è¯´æ˜..."></textarea>
      </div>
      <div class="wm-modal-actions">
        <button id="wmModalCancel" class="btn" type="button">æŒ‰é»˜è®¤ç»§ç»­</button>
        <button id="wmModalOk" class="btn" type="button">æäº¤å¹¶ç»§ç»­</button>
      </div>
    </div>
  </div>

  <!-- Readonly Modal for candidates -->
  <div id="wmListModal" class="wm-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true" style="z-index:60;">
    <div class="wm-modal" style="width:min(980px, 96%); height:80vh; display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 6px;">
        <h3 id="wmListTitle" style="margin: 6px 0 10px; color: var(--accent2); font-size: 1.05rem;">åˆ—è¡¨</h3>
        <button id="wmListClose" class="btn" type="button">å…³é—­</button>
      </div>
      <div style="padding:0 6px 10px;">
        <input id="wmListSearch" class="input" placeholder="è¿‡æ»¤ï¼ˆå§“å/å…³é”®è¯ï¼‰..." style="width:100%; min-width:0;" />
      </div>
      <div id="wmListBody" style="flex:1; overflow:auto; padding:6px; border:1px solid var(--border); border-radius:12px; background: var(--panel2);"></div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Theme
    // ----------------------------
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const saved = localStorage.getItem('theme');
    if (saved === 'light' || saved === 'dark') root.setAttribute('data-theme', saved);
    else root.setAttribute('data-theme', 'light');
    themeBtn.addEventListener('click', () => {
      const cur = root.getAttribute('data-theme') || 'light';
      const next = cur === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    // ----------------------------
    // Utils
    // ----------------------------
    function esc(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'", '&#039;');
    }
    function nowTs(){ return Date.now(); }
    function fmtTime(ts){
      try { return new Date(ts).toLocaleString(); }
      catch(_) { return ''; }
    }

    // ----------------------------
    // DOM
    // ----------------------------
    const workspace = document.getElementById('workspace');
    const topicListEl = document.getElementById('topicList');
    const sessionListEl = document.getElementById('sessionList');
    const wmModeHint = document.getElementById('wmModeHint');

    const apiKeyInput = document.getElementById('apiKey');
    const deepCb = document.getElementById('deep');
    const qInput = document.getElementById('q');
    const sendBtn = document.getElementById('send');

    const runningOverlay = document.getElementById('runningOverlay');
    const btnFastProfile = document.getElementById('btnFastProfile');
    const btnCancel = document.getElementById('btnCancel');

    const modeTopicBtn = document.getElementById('modeTopic');
    const modePersonBtn = document.getElementById('modePerson');

    // candidates modal
    const listModal = document.getElementById('wmListModal');
    const listTitle = document.getElementById('wmListTitle');
    const listBody = document.getElementById('wmListBody');
    const listSearch = document.getElementById('wmListSearch');
    const listClose = document.getElementById('wmListClose');
    listClose.addEventListener('click', () => listModal.classList.remove('is-open'));

    // ----------------------------
    // API key storage
    // ----------------------------
    function getApiKey(){ return sessionStorage.getItem('api_key') || ''; }
    function setApiKey(v){ if(!v) sessionStorage.removeItem('api_key'); else sessionStorage.setItem('api_key', v); }
    apiKeyInput.value = getApiKey();
    apiKeyInput.addEventListener('input', () => setApiKey(apiKeyInput.value.trim()));

    // ----------------------------
    // Sessions
    // ----------------------------
    const SESSION_KEY = 'wm_sessions_v1';
    let activeSessionId = null;
    let mode = 'topic';

    function loadSessions(){
      try{
        const raw = localStorage.getItem(SESSION_KEY);
        const xs = raw ? JSON.parse(raw) : [];
        return Array.isArray(xs) ? xs : [];
      }catch(_){ return []; }
    }
    function saveSessions(xs){
      localStorage.setItem(SESSION_KEY, JSON.stringify(xs || []));
    }

    function upsertSession(patch){
      const xs = loadSessions();
      const i = xs.findIndex(s => s && s.session_id === patch.session_id);
      if (i >= 0) xs[i] = { ...xs[i], ...patch, updated_at: nowTs() };
      else xs.unshift({
        session_id: patch.session_id,
        created_at: patch.created_at || nowTs(),
        updated_at: nowTs(),
        status: patch.status || 'running',
        kind: patch.kind,
        query: patch.query,
        job_id: patch.job_id || '',
        result: patch.result || null,
        artifacts: patch.artifacts || [],
        last_stage: patch.last_stage || 'queued',
        progress: patch.progress || null,
        logs: patch.logs || [],
      });
      saveSessions(xs);
      renderSessionList();
    }

    function appendArtifact(sessionId, art){
      const xs = loadSessions();
      const i = xs.findIndex(s => s && s.session_id === sessionId);
      if (i < 0) return;
      const arts = Array.isArray(xs[i].artifacts) ? xs[i].artifacts : [];
      arts.push({ ts: nowTs(), ...art });
      xs[i].artifacts = arts.slice(-80);
      xs[i].updated_at = nowTs();
      saveSessions(xs);
    }
    function appendLog(sessionId, line){
      const xs = loadSessions();
      const i = xs.findIndex(s => s && s.session_id === sessionId);
      if (i < 0) return;
      const logs = Array.isArray(xs[i].logs) ? xs[i].logs : [];
      const msg = String(line || '').trim();
      if (!msg) return;
      if (logs.length && logs[logs.length-1] === msg) return;
      logs.push(msg);
      xs[i].logs = logs.slice(-120);
      xs[i].updated_at = nowTs();
      saveSessions(xs);
    }

    function setActiveSession(sessionId){
      activeSessionId = sessionId;
      renderSessionList();
      renderSessionView(sessionId);
    }
    window.setActiveSession = setActiveSession;

    function renderSessionList(){
      const xs = loadSessions();
      if (!xs.length){
        sessionListEl.innerHTML = `<div class="muted" style="padding:10px;">æš‚æ— </div>`;
        return;
      }
      sessionListEl.innerHTML = xs.slice(0, 40).map(s => {
        const title = s.kind === 'topic' ? `ä¸»é¢˜ï¼š${s.query || ''}` : `äººç‰©ï¼š${s.query || ''}`;
        const meta = `${fmtTime(s.created_at)} Â· ${s.status || ''}`;
        const active = (s.session_id === activeSessionId) ? 'is-active' : '';
        return `
          <div class="wm-topic-item ${active}" onclick="window.setActiveSession('${esc(s.session_id)}')">
            <button class="wm-delete-btn" title="åˆ é™¤ä¼šè¯" onclick="window.deleteSession('${esc(s.session_id)}', event)">Ã—</button>
            <div class="wm-topic-title">${esc(title)}</div>
            <div class="wm-topic-meta">${esc(meta)}</div>
          </div>
        `;
      }).join('');
    }

    window.deleteSession = (sid, e) => {
      if (e) e.stopPropagation();
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯è®°å½•å—ï¼Ÿï¼ˆä»…åˆ é™¤æœ¬åœ°ï¼‰')) return;
      let xs = loadSessions();
      xs = xs.filter(x => x && x.session_id !== sid);
      saveSessions(xs);
      if (activeSessionId === sid){
        activeSessionId = null;
        renderSessionView(null);
      }
      renderSessionList();
    };

    function setMode(next, opts){
      const silent = !!(opts && opts.silent);
      mode = next;
      modeTopicBtn.classList.toggle('is-active', mode==='topic');
      modePersonBtn.classList.toggle('is-active', mode==='person');
      if (wmModeHint) wmModeHint.textContent = (mode==='topic')
        ? 'ä¸»é¢˜æµæ°´çº¿ï¼šè¾“å…¥ä¸€æ®µè°ƒç ”éœ€æ±‚'
        : 'äººç‰©æ·±æœï¼šè¾“å…¥ä¸€ä¸ªäººå';
      if (mode==='topic') qInput.placeholder = 'è¾“å…¥è°ƒç ”éœ€æ±‚ï¼ˆçº¯æ–‡å­—ï¼‰ï¼šå»ºè®®åŒ…å«ä¸»é¢˜/å®šä¹‰ã€æ—¶é—´èŒƒå›´ã€æ’é™¤é¡¹ã€å­æ–¹å‘ã€‚';
      else qInput.placeholder = 'è¾“å…¥äººç‰©å§“åï¼šä¾‹å¦‚ å‘¨å¿—å / Fei-Fei Li';
      if (!silent) pushBot(`å·²åˆ‡æ¢åˆ° ${mode==='topic' ? 'ä¸»é¢˜æœç´¢' : 'äººç‰©æ·±æœ'} æ¨¡å¼ã€‚`);
    }

    modeTopicBtn.addEventListener('click', () => setMode('topic'));
    modePersonBtn.addEventListener('click', () => setMode('person'));

    // ----------------------------
    // Minimal workspace message helpers
    // ----------------------------
    function pushBot(text){
      const el = document.createElement('div');
      el.className = 'wm-msg bot';
      el.innerHTML = `<div class="wm-bubble">${esc(text)}</div>`;
      workspace.appendChild(el);
      workspace.scrollTop = workspace.scrollHeight;
    }

    // ----------------------------
    // Render Session View (dashboard-ish)
    // ----------------------------
    function renderStickyHeader(session){
      if (!session) return '';
      const kind = session.kind;
      const status = session.status || '';
      const st = session.last_stage || '';
      let deepPct = 0, profPct = 0, deepMeta = '', profMeta = '';
      if (kind === 'topic' && session.progress){
        const d = session.progress.deepresearch || {done:0,total:0};
        const p = session.progress.profile || {done:0,total:0};
        const t = session.progress.detailing || {done:0,total:0,updated:0,failed:0};
        deepPct = d.total ? Math.round(100*d.done/d.total) : 0;
        profPct = p.total ? Math.round(100*p.done/p.total) : 0;
        deepMeta = `${d.done}/${d.total}`;
        profMeta = `${p.done}/${p.total}`;
        if (session.status === 'detailing') {
          deepMeta = `detailing ${t.done}/${t.total} Â· ok ${t.updated} Â· fail ${t.failed}`;
          deepPct = t.total ? Math.round(100*t.done/t.total) : 0;
        }
      }
      return `
        <div class="wm-sticky-header">
          <div class="wm-header-row">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <span class="chip">${esc(kind)}</span>
              <span style="font-weight:900;">${esc(session.query || '')}</span>
              <span class="muted mono" style="font-size:0.85rem;">${esc(session.job_id || '')}</span>
            </div>
            <div class="muted mono" style="font-size:0.85rem;">${esc(status)} Â· ${esc(st)}</div>
          </div>

          ${kind === 'topic' ? `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--muted);">
                <span>DeepResearch</span><span class="mono">${esc(deepMeta)}</span>
              </div>
              <div class="wm-mini-progress"><div class="wm-mini-fill" style="width:${deepPct}%"></div></div>
            </div>
            <div>
              <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--muted);">
                <span>Profile</span><span class="mono">${esc(profMeta)}</span>
              </div>
              <div class="wm-mini-progress"><div class="wm-mini-fill" style="width:${profPct}%"></div></div>
            </div>
          </div>` : ''}
        </div>
      `;
    }

    function renderTimeline(session){
      const arts = Array.isArray(session.artifacts) ? session.artifacts : [];
      let html = `<div class="wm-timeline">`;

      for (let i=0; i<arts.length; i++){
        const a = arts[i] || {};
        const when = a.ts ? fmtTime(a.ts) : '';

        if (a.kind === 'plan'){
          const p = a.plan || {};
          html += `
            <div class="wm-card">
              <div class="wm-card-header">ğŸ“‹ Plan <span class="muted" style="margin-left:auto;">${esc(when)}</span></div>
              <div class="wm-card-body">
                <div style="margin-bottom:10px;">
                  ${(p.keywords||[]).map(k => `<span class="wm-tag">${esc(k)}</span>`).join('')}
                </div>
                ${p.definition ? `<div class="wm-quote-box">${esc(p.definition)}</div>` : `<div class="muted">definitionï¼šæœªæä¾›æˆ–ä¸æ¸…æ™°</div>`}
              </div>
            </div>
          `;
        }

        if (a.kind === 'candidates'){
          const preview = (a.items_preview||[]).slice(0,5).map(x=>x.name).filter(Boolean).join(', ');
          html += `
            <div class="wm-card">
              <div class="wm-card-header">ğŸ‘¥ Candidates <span class="muted" style="margin-left:auto;">${esc(when)}</span></div>
              <div class="wm-card-body">
                <div class="muted">total_candidates: <span class="mono">${esc(a.total_candidates ?? '')}</span></div>
                <div class="muted" style="margin-top:6px;">Top5: <span style="color:var(--text);">${esc(preview)}...</span></div>
                <div style="margin-top:12px;">
                  <button class="btn" type="button" style="width:100%;" onclick="window.__viewCandidates('${esc(session.session_id)}', ${i})">
                    æŸ¥çœ‹å€™é€‰äººï¼ˆå½“å‰ artifact é¢„è§ˆï¼š${(a.items_preview||[]).length}ï¼‰
                  </button>
                  <div class="muted" style="margin-top:6px; font-size:0.85rem;">
                    è¯´æ˜ï¼šOpenAlex å®Œæ•´å‡ ç™¾äººç»“æœç›®å‰ä¸é€šè¿‡ SSE ä¸‹å‘ï¼ˆå¤ªå¤§ï¼‰ã€‚ä»»åŠ¡å®Œæˆåå»ºè®®è·³è½¬ index.html æŸ¥çœ‹å®Œæ•´ profile å¤§è¡¨ã€‚
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        if (a.kind === 'result'){
          const topicId = a.topic_id || (session.result && session.result.topic_id);
          const topicQuery = session.query || '';
          const url = `index.html?q=${encodeURIComponent(topicQuery)}&sort=S_prime_desc`;

          html += `
            <div class="wm-card" style="border-color:var(--accent);">
              <div class="wm-card-header" style="color:var(--accent);">ğŸ Result <span class="muted" style="margin-left:auto;">${esc(when)}</span></div>
              <div class="wm-card-body" style="display:flex; gap:10px; flex-wrap:wrap;">
                <a class="btn" href="${esc(url)}" target="_blank" style="text-decoration:none;">
                  æ‰“å¼€å®Œæ•´æ¦œå•ï¼ˆindex.html Â· profileå¤§è¡¨ï¼‰
                </a>
                ${topicId ? `
                  <button class="btn" type="button" onclick="window.__openTopic('${esc(topicId)}')">
                    æŸ¥çœ‹è¯¥ä¸»é¢˜æ¦œå•ï¼ˆtopic.jsonï¼‰
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }
      }

      // processing line
      if (session.status === 'running'){
        const lastLog = (session.logs && session.logs.length) ? session.logs[session.logs.length-1] : 'Processing...';
        html += `
          <div class="wm-processing-stream">
            <div class="wm-processing-icon">âš¡</div>
            <div class="wm-stream-text">${esc(lastLog)}</div>
          </div>
        `;
      }

      html += `</div>`;
      return html;
    }

    function renderSessionView(sessionId){
      workspace.innerHTML = '';
      if (!sessionId){
        pushBot('æ¬¢è¿ä½¿ç”¨æœç´¢è°ƒæŸ¥é¡µã€‚è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¼šè¯æˆ–åœ¨ä¸‹æ–¹å‘èµ·ä»»åŠ¡ã€‚');
        runningOverlay.style.display = 'none';
        return;
      }
      const xs = loadSessions();
      const s = xs.find(x => x && x.session_id === sessionId);
      if (!s){
        pushBot('Session ä¸å­˜åœ¨ã€‚');
        runningOverlay.style.display = 'none';
        return;
      }

      workspace.innerHTML = renderStickyHeader(s) + renderTimeline(s);

      if (s.status === 'running'){
        runningOverlay.style.display = 'flex';
        btnCancel.onclick = () => window.__cancelJob();
        const hasCand = (s.artifacts||[]).some(a => a && a.kind === 'candidates');
        if (s.kind === 'topic' && hasCand){
          btnFastProfile.style.display = 'block';
          btnFastProfile.onclick = () => window.__fastProfileActiveJob();
        } else {
          btnFastProfile.style.display = 'none';
          btnFastProfile.onclick = null;
        }
      } else {
        runningOverlay.style.display = 'none';
        btnFastProfile.onclick = null;
        btnCancel.onclick = null;
      }
    }

    // ----------------------------
    // Candidates modal: show preview list
    // ----------------------------
    function renderCandidatesTable(items){
      const rows = (items||[]).map((it, i) => {
        const score = (typeof it.score === 'number') ? it.score.toFixed(1) : (it.score ?? '-');
        const openalex = it.openalex_id ? `<a class="link" href="${esc(it.openalex_id)}" target="_blank">OpenAlex</a>` : '';
        const kws = (it.keywords_hit||[]).slice(0,6).map(k => `<span class="chip">#${esc(k)}</span>`).join(' ');
        return `
          <tr>
            <td class="mono">${i+1}</td>
            <td>
              <div style="font-weight:900;">${esc(it.name || '')}</div>
              <div class="muted" style="margin-top:4px;">${kws}</div>
            </td>
            <td class="mono">${esc(score)}</td>
            <td class="mono hide-sm">${esc(it.related_works ?? '-')}</td>
            <td class="mono hide-sm">${esc(it.related_citations_sum ?? '-')}</td>
            <td class="mono hide-sm">${esc(it.related_recent_3y ?? '-')}</td>
            <td style="text-align:right;">${openalex}</td>
          </tr>
        `;
      }).join('');

      listBody.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>ç ”ç©¶è€…</th>
              <th style="width:90px;">score</th>
              <th class="hide-sm" style="width:90px;">works</th>
              <th class="hide-sm" style="width:110px;">citations</th>
              <th class="hide-sm" style="width:90px;">recent3y</th>
              <th style="width:90px; text-align:right;">links</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="7"><div class="muted" style="padding:16px;">æ— ç»“æœ</div></td></tr>`}</tbody>
        </table>
      `;
    }

    window.__viewCandidates = (sid, artIdx) => {
      const xs = loadSessions();
      const s = xs.find(x => x && x.session_id === sid);
      if (!s) return;
      const art = (s.artifacts||[])[artIdx];
      if (!art || art.kind !== 'candidates') return;

      const all = art.items_preview || [];
      listTitle.textContent = `å€™é€‰äººé¢„è§ˆï¼ˆ${all.length}ï¼‰`;
      listSearch.value = '';
      renderCandidatesTable(all);

      listSearch.oninput = () => {
        const q = (listSearch.value || '').trim().toLowerCase();
        if (!q){ renderCandidatesTable(all); return; }
        const filtered = all.filter(it => {
          const name = String(it.name||'').toLowerCase();
          const kws = (it.keywords_hit||[]).join(' ').toLowerCase();
          return name.includes(q) || kws.includes(q);
        });
        renderCandidatesTable(filtered);
      };

      listModal.classList.add('is-open');
      listModal.setAttribute('aria-hidden', 'false');
    };

    // ----------------------------
    // Need input modal
    // ----------------------------
    function openModal({ title, desc, placeholder }){
      const bd = document.getElementById('wmModal');
      const t = document.getElementById('wmModalTitle');
      const d = document.getElementById('wmModalDesc');
      const inp = document.getElementById('wmModalInput');
      const ok = document.getElementById('wmModalOk');
      const cancel = document.getElementById('wmModalCancel');

      t.textContent = title || 'éœ€è¦è¡¥å……ä¿¡æ¯';
      d.textContent = desc || '';
      inp.value = '';
      inp.placeholder = placeholder || 'è¯·è¡¥å……è¯´æ˜...';

      bd.classList.add('is-open');
      bd.setAttribute('aria-hidden', 'false');
      window.setTimeout(() => inp.focus(), 0);

      return new Promise((resolve) => {
        function close(ret){
          bd.classList.remove('is-open');
          bd.setAttribute('aria-hidden', 'true');
          ok.removeEventListener('click', onOk);
          cancel.removeEventListener('click', onCancel);
          bd.removeEventListener('click', onBackdrop);
          document.removeEventListener('keydown', onKey);
          resolve(ret);
        }
        function onOk(){ close({ ok:true, text: (inp.value||'').trim() }); }
        function onCancel(){ close({ ok:false, text:'' }); }
        function onBackdrop(e){ if (e.target === bd) onCancel(); }
        function onKey(e){ if (e.key === 'Escape') onCancel(); }
        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);
        bd.addEventListener('click', onBackdrop);
        document.addEventListener('keydown', onKey);
      });
    }

    // ----------------------------
    // API calls
    // ----------------------------
    async function submitJob(kind, query, apiKey, deep){
      const url = (kind==='topic') ? '/api/jobs/topic' : '/api/jobs/investigate';
      const body = (kind==='topic')
        ? { topic: query, api_key: apiKey, deepsearch: deep }
        : { name: query, api_key: apiKey, deepsearch: deep };
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (!res.ok) throw new Error(`æäº¤å¤±è´¥: ${res.status}`);
      return await res.json();
    }

    async function continueJob(jobId, apiKey, text){
      const res = await fetch(`/api/jobs/${encodeURIComponent(jobId)}/continue`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ api_key: apiKey, text })
      });
      if (!res.ok) throw new Error(`ç»§ç»­å¤±è´¥: ${res.status}`);
      return await res.json();
    }

    async function fastProfile(jobId){
      const res = await fetch(`/api/jobs/${encodeURIComponent(jobId)}/fast_profile`, { method:'POST' });
      if (!res.ok) throw new Error(`è¯·æ±‚å¤±è´¥: ${res.status}`);
      return await res.json();
    }

    async function cancelJob(jobId){
      const res = await fetch(`/api/jobs/${encodeURIComponent(jobId)}/cancel`, { method:'POST' });
      if (!res.ok) throw new Error(`å–æ¶ˆå¤±è´¥: ${res.status}`);
      return await res.json();
    }

    // ----------------------------
    // SSE watcher
    // ----------------------------
    async function watchJob(jobId, kind, query){
      const sessionId = activeSessionId;
      const es = new EventSource(`/api/jobs/${jobId}/events`);
      let prog = { deepresearch: {done:0,total:0}, profile: {done:0,total:0} };

      function stopSession(status, stage, message){
        syncSession({ status, last_stage: stage || status });
        if (message) appendLog(sessionId, message);
        try { es.close(); } catch (_) {}
        if (activeSessionId === sessionId) renderSessionView(sessionId);
      }

      function syncSession(patch){
        upsertSession({ session_id: sessionId, ...patch });
        if (activeSessionId === sessionId) renderSessionView(sessionId);
      }

      es.addEventListener('stage', (e) => {
        const d = JSON.parse(e.data);
        syncSession({ last_stage: d.stage || 'queued' });
      });
      es.addEventListener('log', (e) => {
        const d = JSON.parse(e.data);
        if (d.message) appendLog(sessionId, d.message);
        if (activeSessionId === sessionId) renderSessionView(sessionId);
      });
      es.addEventListener('artifact', (e) => {
        const d = JSON.parse(e.data);
        appendArtifact(sessionId, d);
        if (activeSessionId === sessionId) renderSessionView(sessionId);
      });
      es.addEventListener('progress', (e) => {
        const d = JSON.parse(e.data);
        if (d.phase === 'deepresearch') prog.deepresearch = { done: d.done||0, total: d.total||0 };
        if (d.phase === 'profile') prog.profile = { done: d.done||0, total: d.total||0 };
        syncSession({ progress: { ...prog } });
      });

      es.addEventListener('need_input', async (e) => {
        const d = JSON.parse(e.data);
        es.close();
        syncSession({ status:'waiting_user', last_stage:'need_input' });
        const qs = (d.questions || []).map(x => `- ${x}`).join('\n');
        const apiKey = getApiKey() || apiKeyInput.value.trim();
        const modal = await openModal({
          title: 'éœ€è¦è¡¥å……ä¿¡æ¯æ‰èƒ½ç»§ç»­',
          desc: `è¯·è¡¥å…… 1-3 å¥å®šä¹‰/èŒƒå›´è¯´æ˜ï¼š\n\n${qs}`,
          placeholder: 'ä¾‹å¦‚ï¼šæˆ‘è¿™é‡Œçš„â€œä¸–ç•Œæ¨¡å‹â€æŒ‡...ï¼ŒåŒ…å«...ï¼Œä¸åŒ…å«...'
        });
        const text = modal.ok && modal.text ? modal.text : 'ï¼ˆå®šä¹‰ä»ä¸æ¸…æ™°ï¼ŒæŒ‰é»˜è®¤ç†è§£ç»§ç»­æ‰§è¡Œï¼‰';
        await continueJob(jobId, apiKey, text);
        syncSession({ status:'running', last_stage:'queued' });
        await watchJob(jobId, kind, query + "\n\n" + text);
      });

      es.addEventListener('cancelled', (e) => {
        stopSession('cancelled', 'cancelled', 'å·²å–æ¶ˆï¼ˆbest-effortï¼‰ï¼šå¯èƒ½ä»æœ‰å°‘é‡åœ¨é€”è¯·æ±‚æ­£åœ¨æ”¶å°¾ã€‚');
      });

      es.addEventListener('fast_profile', (e) => {
        const d = (() => { try { return JSON.parse(e.data); } catch(_) { return {}; } })();
        // Keep running but reflect stage so UI doesn't look stuck.
        syncSession({ last_stage: 'fast_profile' });
        appendLog(sessionId, `å·²è¯·æ±‚ fast_profileï¼ˆ${d.where || 'signal'}ï¼‰`);
        if (activeSessionId === sessionId) renderSessionView(sessionId);
      });

      es.addEventListener('done', async (e) => {
        const d = JSON.parse(e.data);
        es.close();

        if (kind === 'topic'){
          const tid = d.topic_id;
          upsertSession({
            session_id: sessionId,
            status: d.detailing ? 'detailing' : 'done',
            last_stage: d.detailing ? 'detailing' : 'done',
            result: { topic_id: tid, topic: d.topic || query }
          });
          appendArtifact(sessionId, { kind:'result', topic_id: tid, topic: d.topic || query });
          await loadTopicList();
          if (activeSessionId === sessionId) renderSessionView(sessionId);

          if (d.detailing) {
            appendLog(sessionId, 'ä¸»æµç¨‹å·²å®Œæˆï¼Œåå°æ­£åœ¨è¡¥å…¨ï¼ˆdetailingï¼‰...');
            startDetailingWatch(sessionId, tid);
          }
        } else {
          upsertSession({
            session_id: sessionId,
            status: 'done',
            last_stage: 'done',
            result: { name: query }
          });
          appendArtifact(sessionId, { kind:'result', name: query });
          if (activeSessionId === sessionId) renderSessionView(sessionId);
        }
      });

      es.addEventListener('error', (e) => {
        try { const d = JSON.parse(e.data); pushBot(`é”™è¯¯ï¼š${d.message||''}`); }
        catch (_) { pushBot('é”™è¯¯'); }
      });
      es.addEventListener('eof', () => es.close());
    }

    async function startDetailingWatch(sessionId, topicId){
      try{
        const es = new EventSource(`/api/topics/${encodeURIComponent(topicId)}/events`);
        es.addEventListener('detail_progress', (e) => {
          const d = JSON.parse(e.data);
          const prog = loadSessions().find(x => x && x.session_id === sessionId)?.progress || {};
          prog.detailing = { done: d.done||0, total: d.total||0, updated: d.updated||0, failed: d.failed||0 };
          upsertSession({ session_id: sessionId, status:'detailing', last_stage:'detailing', progress: prog });
          if (activeSessionId === sessionId) renderSessionView(sessionId);
        });
        es.addEventListener('detail_person_updated', (e) => {
          const d = JSON.parse(e.data);
          appendLog(sessionId, `å·²è¡¥å…¨ï¼š${d.name || ''}ï¼ˆrev ${d.revision || ''}ï¼‰`);
          if (activeSessionId === sessionId) renderSessionView(sessionId);
        });
        es.addEventListener('detail_done', (e) => {
          appendLog(sessionId, 'detailing å®Œæˆã€‚');
          upsertSession({ session_id: sessionId, status:'done', last_stage:'done' });
          try { es.close(); } catch(_){ }
          if (activeSessionId === sessionId) renderSessionView(sessionId);
        });
        es.addEventListener('detail_error', (e) => {
          const d = (() => { try { return JSON.parse(e.data); } catch(_) { return {}; } })();
          appendLog(sessionId, `detailing é”™è¯¯ï¼š${d.message || ''}`);
          if (activeSessionId === sessionId) renderSessionView(sessionId);
        });
        es.addEventListener('eof', () => { try { es.close(); } catch(_){} });
      }catch(e){
        appendLog(sessionId, `detailing è®¢é˜…å¤±è´¥ï¼š${e.message}`);
      }
    }

    // ----------------------------
    // Controls
    // ----------------------------
    window.__fastProfileActiveJob = async () => {
      try{
        const sid = activeSessionId;
        if (!sid) return;
        const s = loadSessions().find(x => x && x.session_id === sid);
        if (!s || !s.job_id) return;
        appendLog(sid, 'è¯·æ±‚ï¼šåœæ­¢ç»§ç»­ DeepResearchï¼Œç›´æ¥è¿›å…¥ Profile ç”Ÿæˆ...');
        await fastProfile(s.job_id);
        appendLog(sid, 'è¯·æ±‚å·²å‘é€ã€‚');
        if (activeSessionId === sid) renderSessionView(sid);
      }catch(e){
        pushBot(`fast_profile å¤±è´¥ï¼š${e.message}`);
      }
    };

    window.__cancelJob = async () => {
      try{
        const sid = activeSessionId;
        if (!sid) return;
        const s = loadSessions().find(x => x && x.session_id === sid);
        if (!s || !s.job_id) return;
        appendLog(sid, 'è¯·æ±‚å–æ¶ˆ...');
        await cancelJob(s.job_id);
        // Optimistically update UI; server will also send SSE cancelled.
        upsertSession({ session_id: sid, status:'cancelled', last_stage:'cancelled' });
        appendLog(sid, 'å–æ¶ˆè¯·æ±‚å·²å‘é€ï¼ˆbest-effortï¼‰ï¼Œç­‰å¾…ä»»åŠ¡æ”¶å°¾...');
        if (activeSessionId === sid) renderSessionView(sid);
      }catch(e){
        pushBot(`å–æ¶ˆå¤±è´¥ï¼š${e.message}`);
      }
    };

    // ----------------------------
    // Topic history
    // ----------------------------
    async function loadTopicList(){
      try{
        const res = await fetch('/api/topics');
        const data = await res.json();
        const items = data.items || [];
        if (!items.length){
          topicListEl.innerHTML = `<div class="muted" style="padding:10px;">æš‚æ— å†å²</div>`;
          return;
        }
        topicListEl.innerHTML = items.map(it => {
          const t = it.topic || '(no topic)';
          const when = it.created_at ? new Date(it.created_at * 1000).toLocaleString() : '';
          return `
            <button class="wm-topic-item" type="button" onclick="window.__openTopic('${esc(it.id)}')">
              <div class="wm-topic-title">${esc(t)}</div>
              <div class="wm-topic-meta">${esc(when)} Â· ${esc(it.item_count)} äºº</div>
            </button>
          `;
        }).join('');
      }catch(e){
        topicListEl.innerHTML = `<div class="error" style="padding:10px;">åŠ è½½å¤±è´¥ï¼š${esc(e.message)}</div>`;
      }
    }

    window.__openTopic = async (id) => {
      try{
        const res = await fetch(`/api/topics/${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error(`API é”™è¯¯: ${res.status}`);
        const data = await res.json();
        setMode('topic', { silent: true });

        const sessionId = `topic-result-${String(id)}`;
        upsertSession({
          session_id: sessionId,
          status: 'done',
          kind: 'topic',
          query: data.topic || id,
          job_id: '',
          last_stage: 'done',
          result: { topic_id: id, topic: data.topic || id },
          artifacts: [
            { kind:'plan', plan: data.plan || {}, ts: nowTs() },
            { kind:'candidates', total_candidates: data.total_candidates, items_preview: (data.items||[]).slice(0, 50), ts: nowTs() },
            { kind:'result', topic_id: id, topic: data.topic || id, ts: nowTs() },
          ],
          progress: null,
          logs: [],
        });
        setActiveSession(sessionId);
      }catch(e){
        pushBot(`æ‰“å¼€å¤±è´¥ï¼š${e.message}`);
      }
    };

    // ----------------------------
    // Send
    // ----------------------------
    async function send(){
      const query = (qInput.value || '').trim();
      if (!query) return;

      const apiKey = getApiKey() || apiKeyInput.value.trim();
      if (!apiKey){ pushBot('è¯·å…ˆè¾“å…¥ API Keyã€‚'); return; }
      setApiKey(apiKey);

      const deep = !!deepCb.checked;

      const kind = (mode==='topic') ? 'topic' : 'person';
      const sessionId = Math.random().toString(16).slice(2) + '-' + Date.now().toString(16);
      upsertSession({ session_id: sessionId, status:'running', kind, query, last_stage:'queued', progress:null, result:null, artifacts:[], logs:[] });
      setActiveSession(sessionId);
      pushBot(`æ­£åœ¨å‘èµ· ${kind==='topic' ? 'ä¸»é¢˜æœç´¢' : 'äººç‰©æ·±æœ'}...`);

      const { job_id } = await submitJob(kind, query, apiKey, deep);
      upsertSession({ session_id: sessionId, job_id });
      await watchJob(job_id, kind, query);

      if (mode !== 'topic') qInput.value = '';
    }

    sendBtn.addEventListener('click', () => send().catch(e => pushBot(`å¤±è´¥ï¼š${e.message}`)));
    qInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send().catch(err => pushBot(`å¤±è´¥ï¼š${err.message}`));
      }
    });

    // init
    setMode('topic', { silent: true });
    loadTopicList();
    renderSessionList();
    const xs = loadSessions();
    if (xs.length) setActiveSession(xs[0].session_id);
    else renderSessionView(null);
  </script>
</body>
</html>
